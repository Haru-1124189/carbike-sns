rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // テスト用にすべてのコレクションへのアクセスを許可（完全開放）
    match /{document=**} {
      allow read, write: if true;
    }
    
    // 管理者機能用のコレクション
    match /reports/{reportId} {
      allow read, write: if request.auth != null;
    }
    
    match /systemSettings/{settingId} {
      allow read, write: if request.auth != null;
    }
    
    // 動画コレクション
    match /videos/{videoId} {
      // 読み取り：認証済みユーザー全員
      allow read: if request.auth != null;
      // 作成：認証済みユーザーで、creatorまたはadminロールを持つユーザー
      allow create: if request.auth != null && 
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['creator', 'admin'] ||
         exists(/databases/$(database)/documents/creatorApplications/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/creatorApplications/$(request.auth.uid)).data.status == 'approved');
      // 更新・削除：動画の作成者または管理者
      allow update, delete: if request.auth != null && 
        (resource.data.authorId == request.auth.uid ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
  }
}
